---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import { supabase } from '../lib/supabase';

// Check authentication
const session = Astro.cookies.get('admin-session');
if (!session || session.value !== 'authenticated') {
    return Astro.redirect('/login');
}

// Fetch existing videos
const { data: videos, error } = await supabase
    .from('videos')
    .select('*')
    .order('created_at', { ascending: false });
---

<Layout title="Subir Videos - Admin">
    <Navbar />
    
    <main class="pt-24 pb-12 px-4">
        <div class="max-w-6xl mx-auto">
            <!-- Upload Section -->
            <div class="bg-[#1a2332] border border-gray-700/50 rounded-2xl shadow-2xl p-8 mb-8">
                <h1 class="text-3xl font-bold text-white mb-6">Subir Video</h1>
                
                <form id="uploadForm" enctype="multipart/form-data" class="space-y-6">
                    <!-- Video Name -->
                    <div>
                        <label for="videoName" class="block text-sm font-medium text-gray-300 mb-2">
                            Nombre del video
                        </label>
                        <input
                            type="text"
                            id="videoName"
                            name="videoName"
                            required
                            placeholder="Ej: Mi video increíble"
                            class="w-full px-4 py-3 bg-[#0f1623] border border-gray-700/50 text-white placeholder-gray-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all"
                        />
                    </div>

                    <!-- Drag and Drop Area -->
                    <div
                        id="dropZone"
                        class="border-2 border-dashed border-gray-600 rounded-xl p-12 text-center hover:border-blue-500/50 transition-all cursor-pointer bg-[#0f1623]/50"
                    >
                        <input
                            type="file"
                            id="videoFile"
                            name="videoFile"
                            accept="video/*"
                            class="hidden"
                            required
                        />
                        <div id="dropContent">
                            <svg class="mx-auto h-16 w-16 text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p class="text-xl text-gray-400 mb-2">Arrastra tu video aquí</p>
                            <p class="text-sm text-gray-500 mb-4">o haz clic para seleccionar</p>
                            <button
                                type="button"
                                id="selectBtn"
                                class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-all"
                            >
                                Seleccionar Archivo
                            </button>
                        </div>
                        <div id="preview" class="hidden">
                            <video id="videoPreview" class="max-h-64 mx-auto rounded-lg mb-4" controls></video>
                            <p id="fileName" class="text-white text-lg mb-2"></p>
                            <p id="fileSize" class="text-gray-400 text-sm mb-4"></p>
                            <button
                                type="button"
                                id="changeBtn"
                                class="text-blue-400 hover:text-blue-300 text-sm underline"
                            >
                                Cambiar video
                            </button>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div id="progressContainer" class="hidden">
                        <div class="bg-gray-700 rounded-full h-3 overflow-hidden">
                            <div id="progressBar" class="bg-blue-600 h-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="progressText" class="text-gray-400 text-sm mt-2 text-center">Subiendo...</p>
                    </div>

                    <!-- Submit Button -->
                    <button
                        type="submit"
                        id="submitBtn"
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-4 px-6 rounded-lg transition-all hover:scale-[1.02] shadow-lg shadow-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                    >
                        Subir Video
                    </button>
                </form>

                <!-- Success Message -->
                <div id="successMessage" class="hidden mt-6 bg-green-500/10 border border-green-500/50 text-green-400 px-4 py-3 rounded-lg">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="flex-1">
                            <p class="font-semibold">¡Video subido exitosamente!</p>
                            <p id="shareLink" class="text-sm mt-1"></p>
                        </div>
                        <button id="copyLinkBtn" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded text-sm transition-all">
                            Copiar enlace
                        </button>
                    </div>
                </div>
            </div>

            <!-- Videos List -->
            <div class="bg-[#1a2332] border border-gray-700/50 rounded-2xl shadow-2xl p-8">
                <h2 class="text-2xl font-bold text-white mb-6">Videos Subidos</h2>
                
                <div id="videosList" class="space-y-4">
                    {videos && videos.length > 0 ? (
                        videos.map((video) => (
                            <div class="bg-[#0f1623] border border-gray-700/50 rounded-lg p-4 flex items-center justify-between hover:border-gray-600 transition-all">
                                <div class="flex items-center gap-4 flex-1">
                                    <div class="bg-blue-600/20 rounded-lg p-3">
                                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-white font-semibold">{video.name}</h3>
                                        <p class="text-gray-400 text-sm">
                                            {new Date(video.created_at).toLocaleDateString('es-ES', { 
                                                year: 'numeric', 
                                                month: 'long', 
                                                day: 'numeric' 
                                            })}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <a
                                        href={`/v/${video.id}`}
                                        target="_blank"
                                        class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition-all"
                                    >
                                        Ver
                                    </a>
                                    <button
                                        class="copy-link-btn bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm transition-all"
                                        data-link={`${Astro.url.origin}/v/${video.id}`}
                                    >
                                        Copiar link
                                    </button>
                                    <button
                                        class="delete-btn bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-sm transition-all"
                                        data-id={video.id}
                                    >
                                        Eliminar
                                    </button>
                                </div>
                            </div>
                        ))
                    ) : (
                        <p class="text-gray-400 text-center py-8">No hay videos subidos aún</p>
                    )}
                </div>
            </div>

            <!-- Logout Button -->
            <div class="text-center mt-8">
                <form method="POST" action="/api/logout">
                    <button
                        type="submit"
                        class="text-gray-400 hover:text-white text-sm transition-all"
                    >
                        Cerrar Sesión
                    </button>
                </form>
            </div>
        </div>
    </main>

    <script>
        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('videoFile') as HTMLInputElement;
        const selectBtn = document.getElementById('selectBtn');
        const changeBtn = document.getElementById('changeBtn');
        const dropContent = document.getElementById('dropContent');
        const preview = document.getElementById('preview');
        const videoPreview = document.getElementById('videoPreview') as HTMLVideoElement;
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');

        selectBtn?.addEventListener('click', () => fileInput.click());
        changeBtn?.addEventListener('click', () => {
            fileInput.value = '';
            dropContent?.classList.remove('hidden');
            preview?.classList.add('hidden');
        });

        fileInput.addEventListener('change', handleFileSelect);

        dropZone?.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500');
        });

        dropZone?.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500');
        });

        dropZone?.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500');
            
            const files = e.dataTransfer?.files;
            if (files && files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        });

        function handleFileSelect() {
            const file = fileInput.files?.[0];
            if (file) {
                dropContent?.classList.add('hidden');
                preview?.classList.remove('hidden');
                
                if (fileName) fileName.textContent = file.name;
                if (fileSize) fileSize.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
                
                const url = URL.createObjectURL(file);
                if (videoPreview) videoPreview.src = url;
            }
        }

        // Form submission
        const uploadForm = document.getElementById('uploadForm') as HTMLFormElement;
        const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const successMessage = document.getElementById('successMessage');

        uploadForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(uploadForm);
            submitBtn.disabled = true;
            progressContainer?.classList.remove('hidden');
            successMessage?.classList.add('hidden');

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Show success message
                    const shareLink = document.getElementById('shareLink');
                    if (shareLink) {
                        shareLink.innerHTML = `<strong>Link:</strong> <a href="${result.url}" class="underline" target="_blank">${result.url}</a>`;
                    }
                    successMessage?.classList.remove('hidden');
                    
                    // Reset form
                    uploadForm.reset();
                    dropContent?.classList.remove('hidden');
                    preview?.classList.add('hidden');
                    
                    // Reload page after 2 seconds to show new video
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert('Error al subir el video');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al subir el video');
            } finally {
                submitBtn.disabled = false;
                progressContainer?.classList.add('hidden');
            }
        });

        // Copy link buttons
        document.querySelectorAll('.copy-link-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const link = btn.getAttribute('data-link');
                if (link) {
                    await navigator.clipboard.writeText(link);
                    const originalText = btn.textContent;
                    btn.textContent = '¡Copiado!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }
            });
        });

        // Copy link from success message
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        copyLinkBtn?.addEventListener('click', async () => {
            const shareLink = document.getElementById('shareLink');
            const link = shareLink?.querySelector('a')?.href;
            if (link) {
                await navigator.clipboard.writeText(link);
                copyLinkBtn.textContent = '¡Copiado!';
                setTimeout(() => {
                    copyLinkBtn.textContent = 'Copiar enlace';
                }, 2000);
            }
        });

        // Delete buttons
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!confirm('¿Estás seguro de eliminar este video?')) return;
                
                const id = btn.getAttribute('data-id');
                const response = await fetch(`/api/delete/${id}`, { method: 'DELETE' });
                
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error al eliminar el video');
                }
            });
        });
    </script>
</Layout>
